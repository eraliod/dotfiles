#!/bin/bash
# Databricks MCP Proxy
# Fetches dynamic OAuth tokens from Databricks CLI profiles
# Usage: databricks-mcp-proxy <PROFILE>

set -euo pipefail

PROFILE="${1:?Usage: databricks-mcp-proxy <PROFILE>}"

# Clear env vars that could override profile settings
unset DATABRICKS_HOST DATABRICKS_TOKEN

# Get workspace host from Databricks CLI config
HOST=$(databricks auth describe --profile "$PROFILE" -o json 2>/dev/null | jq -r '.details.configuration.host.value')
if [[ -z "$HOST" || "$HOST" == "null" ]]; then
  echo "Error: Could not determine host for profile: $PROFILE" >&2
  echo "Run 'databricks auth login --profile $PROFILE' first" >&2
  exit 1
fi

# Get fresh OAuth token
TOKEN=$(databricks auth token --profile "$PROFILE" 2>/dev/null | jq -r '.access_token')
if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
  echo "Error: Could not get token for profile: $PROFILE" >&2
  echo "Run 'databricks auth login --profile $PROFILE' first" >&2
  exit 1
fi

# Track MCP server start time for token expiry detection
mkdir -p ~/.cache/claude
date +%s > ~/.cache/claude/databricks-mcp-start-${PROFILE}

# Start mcp-remote with dynamic credentials
exec npx mcp-remote "${HOST}/api/2.0/mcp/sql" --header "Authorization: Bearer $TOKEN"
